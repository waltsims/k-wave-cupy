name: Run Tests

on:
  push:
    branches:
       - main
  pull_request:
    branches:
       - main

jobs:
  # Generate reference data for each dimension (MATLAB backend)
  generate-reference-data:
    name: Generate ${{ matrix.dim }}D reference data
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        dim: [1, 2, 3]
    steps:
      - uses: actions/checkout@v4

      - name: Set up MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          products: Signal_Processing_Toolbox
          cache: true

      - name: Generate reference data
        uses: matlab-actions/run-command@v2
        with:
          command: |
            addpath('k-Wave');
            cd('k-Wave/testing/unit');
            kspaceFirstOrder${{ matrix.dim }}D_compare_plane_waves(false, false);

      - name: Upload reference data
        uses: actions/upload-artifact@v4
        with:
          name: reference_data_${{ matrix.dim }}D
          path: k-Wave/testing/unit/kspaceFirstOrder${{ matrix.dim }}D_reference_data.mat

  # Python parity tests by dimension (Python backend via shims vs MATLAB reference)
  python-parity-tests:
    name: Python parity (${{ matrix.dim }}D)
    runs-on: ubuntu-latest
    needs: generate-reference-data
    strategy:
      fail-fast: false
      matrix:
        dim: [1, 2, 3]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        id: setup-python
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: pip install numpy scipy

      - name: Set up MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          products: Signal_Processing_Toolbox
          cache: true

      - name: Download reference data
        uses: actions/download-artifact@v4
        with:
          name: reference_data_${{ matrix.dim }}D
          path: k-Wave/testing/unit

      - name: Run ${{ matrix.dim }}D parity tests
        uses: matlab-actions/run-command@v2
        env:
          PYTHON_PATH: ${{ steps.setup-python.outputs.python-path }}
        with:
          command: |
            addpath('tests');
            results = run_py_tests(${{ matrix.dim }});
            if ~all([results.passed])
              error('${{ matrix.dim }}D parity tests failed');
            end

  # Python-specific feature tests (no reference data needed)
  python-feature-tests:
    name: Python feature tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        id: setup-python
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: pip install numpy scipy

      - name: Set up MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          products: Signal_Processing_Toolbox
          cache: true

      - name: Run Python feature tests
        uses: matlab-actions/run-command@v2
        env:
          PYTHON_PATH: ${{ steps.setup-python.outputs.python-path }}
        with:
          command: |
            addpath('tests');
            results = run_py_tests();
            if ~all([results.passed])
              error('Python feature tests failed');
            end

  regression-tests:
    name: Regression tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Set up MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          products: Signal_Processing_Toolbox
          cache: true

      - name: Generate and run regression tests
        uses: matlab-actions/run-command@v2
        with:
          command: |
            addpath('k-Wave');
            cd('k-Wave/testing/regression');
            generateRegressionData;
            runRegressionTests(pwd, false);
