name: Run Tests

on:
  push:
    branches:
       - main
  pull_request:
    branches:
       - main

jobs:
  unit-tests-matlab:
    name: Unit tests (MATLAB - 1D)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          products: Signal_Processing_Toolbox
          cache: true

      - name: Run 1D unit tests and generate reference data
        uses: matlab-actions/run-command@v2
        with:
          command: |
            addpath('k-Wave');
            cd('k-Wave/testing/unit');
            runUnitTests('kspaceFirstOrder1D', false);
            kspaceFirstOrder1D_compare_plane_waves(false, false);

      - name: Upload reference data
        uses: actions/upload-artifact@v4
        with:
          name: reference_data
          path: k-Wave/testing/unit/kspaceFirstOrder1D_reference_data.mat

  python-backend-parity:
    name: Python backend parity (1D comprehensive)
    runs-on: ubuntu-latest
    needs: unit-tests-matlab
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        id: setup-python
        with:
          python-version: '3.10'

      - name: Install NumPy
        run: pip install numpy

      - name: Set up MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          products: Signal_Processing_Toolbox
          cache: true

      - name: Download reference data
        uses: actions/download-artifact@v4
        with:
          name: reference_data
          path: k-Wave/testing/unit

      - name: Run Python backend parity test
        uses: matlab-actions/run-command@v2
        env:
          PYTHON_PATH: ${{ steps.setup-python.outputs.python-path }}
        with:
          command: |
            pyenv('Version', getenv('PYTHON_PATH'));
            addpath('k-Wave');
            addpath('tests/shims');
            cd('k-Wave/testing/unit');
            result = kspaceFirstOrder1D_compare_plane_waves(false, false);
            if ~result
              error('Python backend parity test failed');
            end

  regression-tests:
    name: Regression tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Set up MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          products: Signal_Processing_Toolbox
          cache: true

      - name: Generate and run regression tests
        uses: matlab-actions/run-command@v2
        with:
          command: |
            addpath('k-Wave');
            cd('k-Wave/testing/regression');
            generateRegressionData;
            runRegressionTests(pwd, false);
