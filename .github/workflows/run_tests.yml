name: Run Tests

on:
  push:
    branches:
       - main
  pull_request:
    branches:
       - main

jobs:
  unit-tests-matlab-baseline:
    name: Unit tests (MATLAB baseline - 1D only)
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          products: Signal_Processing_Toolbox
          cache: true

      - name: Run unit tests (1D only)
        uses: matlab-actions/run-command@v2
        with:
          command: |
            addpath('${{ github.workspace }}/k-Wave');
            cd('${{ github.workspace }}/k-Wave/testing/unit');
            test_struct = runUnitTests('kspaceFirstOrder1D',false);
            save('test_struct.mat', 'test_struct');
          startup-options: -nojvm -logfile output.log

      - name: Create artifact
        uses: matlab-actions/run-command@v2
        with:
          command: |
            addpath('${{ github.workspace }}/k-Wave/testing');
            cd('${{ github.workspace }}/k-Wave/testing/unit');
            load('test_struct.mat', 'test_struct');
            save_artifact(test_struct);
          startup-options: -nojvm 

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: unit_test_results_matlab
          path: ${{ github.workspace }}/k-Wave/testing/unit/test_results.json

      - name: Upload reference data
        uses: actions/upload-artifact@v4
        with:
          name: reference_data
          path: ${{ github.workspace }}/k-Wave/testing/unit/kspaceFirstOrder1D_reference_data.mat

      - name: Test results
        uses: matlab-actions/run-command@v2
        with:
          command: |
            addpath('${{ github.workspace }}/k-Wave/testing');
            cd('${{ github.workspace }}/k-Wave/testing/unit');
            load('test_struct.mat', 'test_struct');
            show_test_results(test_struct);
            disp('  ');
            disp('NOTE:');
            disp('Test output details are in the "Run unit tests" section of the workflow.');
            disp('You can also download a JSON summary from the "Upload Artifact" section in your CI logs or dashboard.');
          startup-options: -nojvm

  unit-tests-python-backend:
    name: Unit tests (Python backend - 1D)
    runs-on: ubuntu-latest
    needs: unit-tests-matlab-baseline
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy

      - name: Set up MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          products: Signal_Processing_Toolbox
          cache: true

      - name: Download reference data
        uses: actions/download-artifact@v4
        with:
          name: reference_data
          path: ${{ github.workspace }}/k-Wave/testing/unit

      - name: Run unit tests (1D with Python backend)
        uses: matlab-actions/run-command@v2
        with:
          command: |
            % Configure Python environment (use setup-python's path)
            [~, py_path] = system('which python3');
            py_path = strtrim(py_path);
            disp(['Using Python at: ' py_path]);
            pyenv('Version', py_path);
            disp(['Python version: ' char(py.sys.version)]);
            disp(['NumPy version: ' char(py.numpy.version.version)]);
            addpath('${{ github.workspace }}/k-Wave');
            addpath('${{ github.workspace }}/tests/shims');
            cd('${{ github.workspace }}/k-Wave/testing/unit');
            test_struct = runUnitTests('kspaceFirstOrder1D',false);
            save('test_struct.mat', 'test_struct');
          startup-options: -logfile output.log

      - name: Upload MATLAB log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: matlab_output_log
          path: /tmp/run_matlab_command-*/output.log

      - name: Create artifact
        uses: matlab-actions/run-command@v2
        with:
          command: |
            addpath('${{ github.workspace }}/k-Wave/testing');
            cd('${{ github.workspace }}/k-Wave/testing/unit');
            load('test_struct.mat', 'test_struct');
            save_artifact(test_struct);
          startup-options: -nojvm

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: unit_test_results_python_backend
          path: ${{ github.workspace }}/k-Wave/testing/unit/test_results.json

      - name: Test results
        uses: matlab-actions/run-command@v2
        with:
          command: |
            addpath('${{ github.workspace }}/k-Wave/testing');
            cd('${{ github.workspace }}/k-Wave/testing/unit');
            load('test_struct.mat', 'test_struct');
            show_test_results(test_struct);
            disp('  ');
            disp('NOTE:');
            disp('Test output details are in the "Run unit tests" section of the workflow.');
            disp('You can also download a JSON summary from the "Upload Artifact" section in your CI logs or dashboard.');
          startup-options: -nojvm

  regression-tests:
    name: Regression tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'  # Only run on main branch
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          products: Signal_Processing_Toolbox
          cache: true

      - name: Generate data
        uses: matlab-actions/run-command@v2
        with:
          command: |
            addpath('${{ github.workspace }}/k-Wave');
            cd('${{ github.workspace }}/k-Wave/testing/regression');
            generateRegressionData
          startup-options: -nojvm 

      - name: Run regression tests
        uses: matlab-actions/run-command@v2
        with:
          command: |
            addpath('${{ github.workspace }}/k-Wave');
            cd('${{ github.workspace }}/k-Wave/testing/regression');
            test_struct = runRegressionTests('${{ github.workspace }}/k-Wave/testing/regression',false);
            save('test_struct.mat', 'test_struct');
          startup-options: -nojvm 

      - name: Create artifact
        uses: matlab-actions/run-command@v2
        with:
          command: |
            addpath('${{ github.workspace }}/k-Wave/testing');
            cd('${{ github.workspace }}/k-Wave/testing/regression');
            load('test_struct.mat', 'test_struct');
            save_artifact(test_struct);
          startup-options: -nojvm

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: regression_test_results
          path: ${{ github.workspace }}/k-Wave/testing/regression/test_results.json

      - name: Test results
        uses: matlab-actions/run-command@v2
        with:
          command: |
            addpath('${{ github.workspace }}/k-Wave/testing');
            cd('${{ github.workspace }}/k-Wave/testing/regression');
            load('test_struct.mat', 'test_struct');
            show_test_results(test_struct);
            disp('  ');
            disp('NOTE:');
            disp('Test output details are in the "Run regression tests" section of the workflow.');
            disp('You can also download a JSON summary from the "Upload Artifact" section in your CI logs or dashboard.');
          startup-options: -nojvm 
